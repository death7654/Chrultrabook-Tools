<div class="position-relative overflow-y-auto" style="height: 100vh">
  <div class="container-fluid p-3 keyboard_container">
    <!-- Header -->
    <div class="row align-items-center mb-3">
      <div class="col">
        <h4 class="fs-4 mb-0">
          <img
            src="../../assets/keyboard/keyboard.svg"
            class="align-text-middle px-2"
            alt="Keyboard"
          />
          Keyboard Configuration
        </h4>
      </div>
    </div>

    <!-- Keyboard Display -->
    <div class="row mb-3">
      <div class="col">
        <div class="p-3 bg-secondary rounded-3 overflow-auto">
          <div
            class="keyboard-display"
            [class.rgb-enabled]="rgbEnabled"
            [style.--rgb-color]="rgbColor"
            [style.--rgb-opacity]="rgbOpacity"
          >
            @for (row of keyboardLayout; track rowIndex; let rowIndex = $index)
            {
            <div class="d-flex gap-1 mb-1 justify-content-center fw-bolder">
              @for (key of row; track colIndex; let colIndex = $index) {
              <button
                class="btn btn-sm key-btn key-text"
                [ngClass]="{
                  'btn-outline-secondary':
                    key.state === 'btn-outline-secondary',
                  'key-selected': isKeySelected(rowIndex, colIndex),
                  'remap-mode': remapMode
                }"
                [style.flex]="key.width"
                (click)="selectKey(rowIndex, colIndex)"
              >
                <span>{{ key.label }}</span>
              </button>
              }
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- RGB Controls -->
    <div class="row mb-3">
      <div class="col">
        <h5 class="fs-3 mb-2">
          <img
            src="../../assets/activity_light/activity.svg"
            class="align-text-middle px-2"
            alt="RGB"
          />
          RGB Lighting Control
        </h5>
        <div class="p-3 bg-secondary rounded-3">
          <div class="row g-2 mb-2">
            <div class="col-auto">
              <div class="form-check">
                <input
                  type="checkbox"
                  [(ngModel)]="rgbEnabled"
                  class="form-check-input"
                  id="rgbEnable"
                />
                <label class="form-check-label fs-5" for="rgbEnable"
                  >Enable RGB</label
                >
              </div>
            </div>
            <div class="col">
              <select
                [(ngModel)]="rgbMode"
                class="form-select form-select-sm"
                [disabled]="!rgbEnabled"
              >
                <option value="static">Static</option>
                <option value="breathing">Breathing</option>
                <option value="wave">Wave</option>
                <option value="rainbow">Rainbow</option>
                <option value="reactive">Reactive</option>
              </select>
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-12">
              <label class="form-label mb-1 fs-4"
                >Brightness: {{ brightness }}%</label
              >
              <input
                type="range"
                [(ngModel)]="brightness"
                min="0"
                max="100"
                class="form-range"
                [disabled]="!rgbEnabled"
              />
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-12 col-md-4">
              <label class="form-label mb-1 fs-4">Red: {{ rgbRed }}</label>
              <input
                type="range"
                [(ngModel)]="rgbRed"
                min="0"
                max="255"
                class="form-range"
                [disabled]="!rgbEnabled || rgbMode === 'rainbow'"
              />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label mb-1 fs-4">Green: {{ rgbGreen }}</label>
              <input
                type="range"
                [(ngModel)]="rgbGreen"
                min="0"
                max="255"
                class="form-range"
                [disabled]="!rgbEnabled || rgbMode === 'rainbow'"
              />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label mb-1 fs-4">Blue: {{ rgbBlue }}</label>
              <input
                type="range"
                [(ngModel)]="rgbBlue"
                min="0"
                max="255"
                class="form-range"
                [disabled]="!rgbEnabled || rgbMode === 'rainbow'"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12">
              <label for="hexInput" class="form-label fs-4">Hex Code:</label>
              <input
                type="text"
                id="hexInput"
                [(ngModel)]="hexCodeInput"
                class="form-control"
                placeholder="Enter Hex Code"
                [disabled]="!rgbEnabled || rgbMode === 'rainbow'"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div
                class="color-preview rounded-3"
                [style.background-color]="rgbColor"
                [style.opacity]="rgbEnabled ? rgbOpacity : 0.3"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Remapping -->
    <div class="row">
      <div class="col">
        <h5 class="fs-3 mb-2">
          <img
            src="../../assets/keyboard/more.svg"
            class="align-text-middle px-2"
            alt="Remap"
          />
          Key Remapping
        </h5>
        <!-- Configuration Table View -->
        @if (showTableView) {
        <div class="col-12" data-bs-theme="dark">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-3">
              <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-white fw-normal">Keyboard Remapping</h3>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-outline-danger btn-sm"
                    (click)="resetToOriginalConfig()"
                  >
                    Hard Reset
                  </button>
                  <button
                    class="btn btn-outline-warning btn-sm"
                    (click)="resetToCurrentConfig()"
                  >
                    Soft Reset
                  </button>
                  <button
                    class="btn btn-outline-success btn-sm"
                    (click)="exportConfigJSON()"
                  >
                    Apply Remap
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <!-- Legend -->
              <div class="card-footer bg-transparent border-0 pb-3" data-bs-theme="dark">
                <div class="row align-items-center">
                  <div class="col-12 text-center">
                    <span class="me-4 text-white">
                      <span class="fw-normal">NoDetect</span> <small class="text-white"> - No detection</small>
                    </span>

                    <span class="me-4 text-white">
                      <span class="fw-normal">Enforce</span> <small class="text-white"> - Must be pressed</small>
                    </span>

                    <span class="me-4 text-white">
                      <span class="fw-normal">EnforceNot</span> <small class="text-white"> - Must not be pressed</small>
                    </span>
                    <br>
                    <br>
                    <span class="text-white fst-italic opacity-75">
                      Click any cell to edit
                    </span>
                  </div>
                </div>
              </div>
                <table class="table table-hover text-white table-sm mb-0" data-bs-theme="dark">
                  <thead class="sticky-top" style="background: rgba(33, 37, 41, 0.95);">
                    <tr>
                      <th class="text-center fw-normal py-3">Index</th>
                      <th class="text-center fw-normal py-3">Original Key</th>
                      <th class="text-center fw-normal py-3">Left Ctrl</th>
                      <th class="text-center fw-normal py-3">Left Alt</th>
                      <th class="text-center fw-normal py-3">Search</th>
                      <th class="text-center fw-normal py-3">Assistant</th>
                      <th class="text-center fw-normal py-3">Left Shift</th>
                      <th class="text-center fw-normal py-3">Right Ctrl</th>
                      <th class="text-center fw-normal py-3">Right Alt</th>
                      <th class="text-center fw-normal py-3">Right Shift</th>
                      <th class="text-center fw-normal py-3">Vivaldi→Fn</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (config of current_remap; track config.index) {
                    <tr class="border-bottom border-secondary">
                      <!-- Index -->
                      <td class="text-center align-middle py-3" data-bs-theme="dark">
                        <span class="fw-normal">{{
                          config.index
                        }}</span>
                      </td>

                      <!-- Original Key -->
                      <td class="text-center align-middle py-3" data-bs-theme="dark">
                        <span class="text-white fw-normal">{{
                          config.original_key.make_code_hex
                        }}</span>
                      </td>

                      <!-- Modifier Fields -->
                      @for (field of modifierFields; track field) {
                      <td class="text-center align-middle p-2" data-bs-theme="dark">
                        @if (isEditingCell(config.index, field)) {
                        <div class="d-flex gap-1 align-items-center justify-content-center">
                          <select
                            class="form-select form-select-sm border-secondary"
                            [value]="$any(config)[field]"
                            (change)="
                              updateConfigField(
                                config.index,
                                field,
                                $any($event.target).value
                              )
                            "
                            style="min-width: 120px"
                          >
                            @for (option of keyStateOptions; track option) {
                            <option [value]="option">{{ option }}</option>
                            }
                          </select>
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            (click)="cancelEditCell()"
                            type="button"
                          >
                            ✕
                          </button>
                        </div>
                        } @else {
                        <div
                          class="d-flex justify-content-between align-items-center px-2 py-1 rounded"
                          (click)="startEditCell(config.index, field)"
                          style="cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"
                          onmouseout="this.style.backgroundColor='transparent'"
                        >
                          <span [class]="getCellClass($any(config)[field])" class="fw-normal">
                            {{ $any(config)[field] }}
                          </span>
                          <small class="text-white opacity-75">✎</small>
                        </div>
                        }
                      </td>
                      }

                      <!-- Remap Vivaldi to Fn -->
                      <td class="text-center align-middle p-2" data-bs-theme="dark">
                        @if (isEditingCell(config.index,
                        'remap_vivaldi_to_fn')) {
                        <div class="d-flex gap-1 align-items-center justify-content-center">
                          <select
                            class="form-select form-select-sm border-secondary"
                            [value]="config.remap_vivaldi_to_fn"
                            (change)="
                              updateConfigField(
                                config.index,
                                'remap_vivaldi_to_fn',
                                $any($event.target).value
                              )
                            "
                            style="min-width: 80px"
                          >
                            <option value="true">True</option>
                            <option value="false">False</option>
                          </select>
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            (click)="cancelEditCell()"
                            type="button"
                          >
                            ✕
                          </button>
                        </div>
                        } @else {
                        <div
                          class="d-flex justify-content-between align-items-center px-2 py-1 rounded"
                          (click)="
                            startEditCell(config.index, 'remap_vivaldi_to_fn')
                          "
                          style="cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"
                          onmouseout="this.style.backgroundColor='transparent'"
                        >
                          <span
                            [class]="
                              config.remap_vivaldi_to_fn
                                ? 'text-success fw-semibold'
                                : 'text-danger fw-semibold'
                            "
                            class="fw-normal"
                          >
                            {{ config.remap_vivaldi_to_fn }}
                          </span>
                          <small class="text-white">✎</small>
                        </div>
                        }
                      </td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>